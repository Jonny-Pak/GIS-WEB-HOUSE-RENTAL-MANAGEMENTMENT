{% extends 'quanly/layouts/dashboard_base.html' %}
{% load static %}

{% block title %}Đăng tin mới{% endblock %}
{% block header_title %}Đăng tin mới{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">

        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="card-custom mb-4">
                <div class="card-body">
                    <h5 class="fw-bold text-primary mb-4 border-bottom pb-2">
                        <i class="bi bi-info-circle me-2"></i>Thông tin cơ bản
                    </h5>

                    <div class="mb-4">
                        <label class="fw-bold mb-2 text-dark">Tiêu đề tin <span class="text-danger">*</span></label>
                        {{ form.name }}
                        <div class="form-text">Tiêu đề ngắn gọn, đầy đủ thu hút người xem hơn.</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="fw-bold mb-2 text-dark">Loại hình <span class="text-danger">*</span></label>
                            {{ form.house_type }}
                        </div>
                        <div class="col-md-6 mb-4">
                            <label class="fw-bold mb-2 text-dark">Diện tích chung (m²)</label>
                            <div class="input-group">
                                {{ form.area }}
                                <span class="input-group-text bg-light">m²</span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="fw-bold mb-2 text-dark">Giá cho thuê <span
                                    class="text-danger">*</span></label>
                            <div class="input-group mb-2">
                                {{ form.price }}
                                <span class="input-group-text bg-light fw-bold text-success">VNĐ</span>
                            </div>
                            <div class="form-check">
                                {{ form.is_negotiable }}
                                <label class="form-check-label fw-bold text-muted small"
                                    for="{{ form.is_negotiable.id_for_label }}">
                                    Cho phép thương lượng giá
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <label class="fw-bold mb-2 text-dark">Tiền cọc (nếu có)</label>
                            <div class="input-group">
                                {{ form.deposit }}
                                <span class="input-group-text bg-light">VNĐ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-custom mb-4">
                <div class="card-body">
                    <h5 class="fw-bold text-primary mb-4 border-bottom pb-2">
                        <i class="bi bi-geo-alt me-2"></i>Vị trí bất động sản
                    </h5>
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <label class="fw-bold mb-2 text-dark">Quận / Huyện <span
                                    class="text-danger">*</span></label>
                            {{ form.district }}
                        </div>
                        <div class="col-md-8 mb-4">
                            <label class="fw-bold mb-2 text-dark">Địa chỉ chi tiết <span
                                    class="text-danger">*</span></label>
                            {{ form.address }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-custom mb-4">
                <div class="card-body">
                    <h5 class="fw-bold text-primary mb-4 border-bottom pb-2">
                        <i class="bi bi-list-check me-2"></i>Thông tin chi tiết
                    </h5>
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <label class="fw-bold mb-2 text-dark">Số người ở tối đa</label>
                            {{ form.max_people }}
                        </div>
                        <div class="col-md-4 mb-4">
                            <label class="fw-bold mb-2 text-dark">Đang ở hiện tại</label>
                            <input type="number" class="form-control py-2" name="current_people" value="0">
                        </div>
                        <div class="col-md-4 mb-4">
                            <label class="fw-bold mb-2 text-dark">SĐT Liên hệ</label>
                            {{ form.owner_phone }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold mb-2 text-dark">Mô tả chi tiết</label>
                        {{ form.description }}
                    </div>
                </div>
            </div>

            <div class="card-custom mb-4">
                <div class="card-body">
                    <h5 class="fw-bold text-primary mb-4 border-bottom pb-2">
                        <i class="bi bi-tag me-2"></i>Quy mô & Tiện ích bổ sung
                    </h5>

                    <div class="row">
                        <div class="col-md-3 mb-4">
                            <label class="fw-bold mb-2 text-dark">Số lượng căn <span
                                    class="text-danger">*</span></label>
                            {{ form.unit_count }}
                        </div>
                        <div class="col-md-3 mb-4">
                            <label class="fw-bold mb-2 text-dark">Số phòng/căn <span
                                    class="text-danger">*</span></label>
                            {{ form.room_count }}
                        </div>
                        <div class="col-md-3 mb-4">
                            <label class="fw-bold mb-2 text-dark">Giá điện</label>
                            {{ form.electricity_price }}
                        </div>
                        <div class="col-md-3 mb-4">
                            <label class="fw-bold mb-2 text-dark">Giá nước</label>
                            {{ form.water_price }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-custom mb-4">
                <div class="card-body">
                    <h5 class="fw-bold text-primary mb-4 border-bottom pb-2">
                        <i class="bi bi-images me-2"></i>Hình ảnh & Video
                    </h5>

                    <div class="mb-4">
                        <label class="fw-bold mb-2 text-dark">1. Ảnh đại diện (Ảnh bìa) <span
                                class="text-danger">*</span></label>
                        <input type="file" class="form-control" name="main_image" accept="image/*"
                            onchange="previewMainImage(event)">

                        <div class="mt-2" id="main-image-preview-box" style="display: none;">
                            <img id="main-img-preview" src="#" alt="Ảnh bìa" class="rounded shadow-sm border"
                                style="max-height: 200px; width: auto;">
                        </div>
                    </div>

                    <hr>

                    <div class="mb-4">
                        <label class="fw-bold mb-2 text-dark">2. Ảnh chi tiết (Chọn nhiều ảnh)</label>
                        <input type="file" class="form-control" name="detail_images" accept="image/*" multiple
                            onchange="previewGalleryImages(event)">
                        <div class="form-text">Giữ phím <strong>Ctrl</strong> (Windows) hoặc <strong>Command</strong>
                            (Mac) để chọn nhiều ảnh.</div>
                    </div>

                    <div class="p-3 border border-dashed rounded bg-light"
                        style="min-height: 200px; border-style: dashed !important; border-color: #ccc;">

                        <div id="gallery-empty-state"
                            class="d-flex flex-column align-items-center justify-content-center pt-5">
                            <i class="bi bi-cloud-arrow-up fs-1 text-muted mb-2"></i>
                            <span class="text-muted">Ảnh chi tiết sẽ hiển thị tại đây</span>
                        </div>

                        <div id="gallery-preview-container" class="row g-3">
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end mb-5 gap-3">
                <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary px-4 py-2 fw-bold rounded-pill">
                    Hủy bỏ
                </a>
                <button type="submit" class="btn btn-danger px-5 py-2 fw-bold rounded-pill shadow-sm">
                    <i class="bi bi-send-fill me-2"></i> Đăng Tin Ngay
                </button>
            </div>

        </form>
    </div>
</div>

{% comment %}
<script>
    // --- 1. Xử lý xem trước Ảnh đại diện (Main Image) ---
    function previewMainImage(event) {
        var reader = new FileReader();
        reader.onload = function () {
            var output = document.getElementById('main-img-preview');
            var box = document.getElementById('main-image-preview-box');
            output.src = reader.result;
            box.style.display = 'block';
        };
        if (event.target.files[0]) {
            reader.readAsDataURL(event.target.files[0]);
        }
    }

    // --- 2. Xử lý xem trước Nhiều ảnh (Gallery) ---
    function previewGalleryImages(event) {
        var container = document.getElementById('gallery-preview-container');
        var emptyState = document.getElementById('gallery-empty-state');
        var files = event.target.files;

        // Xóa ảnh cũ nếu chọn lại
        container.innerHTML = "";

        if (files.length > 0) {
            emptyState.style.display = 'none';

            for (var i = 0; i < files.length; i++) {
                var file = files[i];
                var reader = new FileReader();

                reader.onload = (function (f) {
                    return function (e) {
                        // Tạo khung col-3
                        var div = document.createElement('div');
                        div.className = 'col-6 col-md-3 position-relative';

                        // Tạo ảnh
                        var img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'img-fluid rounded shadow-sm border';
                        img.style.width = '100%';
                        img.style.height = '150px';
                        img.style.objectFit = 'cover';

                        div.appendChild(img);
                        container.appendChild(div);
                    };
                })(file);

                reader.readAsDataURL(file);
            }
        } else {
            emptyState.style.display = 'flex';
        }
    }
</script> {% endcomment %}
{% endblock %}