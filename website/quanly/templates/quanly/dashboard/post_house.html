{% extends 'quanly/layouts/dashboard_base.html' %}
{% load static %}

{% block title %}Đăng tin mới{% endblock %}
{% block header_title %}Đăng tin mới{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="card-custom mb-4">
                <div class="card-body">
                    <h5 class="fw-bold text-primary mb-4 border-bottom pb-2">
                        <i class="bi bi-info-circle me-2"></i>Thông tin cơ bản
                    </h5>
                    
                    <div class="mb-4">
                        <label class="fw-bold mb-2 text-dark">Tiêu đề tin <span class="text-danger">*</span></label>
                        <input type="text" class="form-control py-2" name="name" placeholder="Ví dụ: Cho thuê phòng trọ cao cấp gần ĐH Bách Khoa..." required>
                        <div class="form-text">Tiêu đề ngắn gọn, đầy đủ thu hút người xem hơn.</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="fw-bold mb-2 text-dark">Loại hình <span class="text-danger">*</span></label>
                            <select class="form-select py-2" name="house_type">
                                <option value="" selected>-- Chọn loại hình --</option>
                                <option value="phong_tro">Phòng trọ</option>
                                <option value="chungcu">Căn hộ chung cư</option>
                                <option value="nguyencan">Nhà nguyên căn</option>
                                <option value="van_phong">Văn phòng</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-4">
                            <label class="fw-bold mb-2 text-dark">Diện tích chung (m²)</label>
                            <div class="input-group">
                                <input type="number" class="form-control py-2" name="area" placeholder="Ví dụ: 30">
                                <span class="input-group-text bg-light">m²</span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="fw-bold mb-2 text-dark">Giá cho thuê <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" class="form-control py-2" name="price" placeholder="Nhập số tiền...">
                                <span class="input-group-text bg-light fw-bold text-success">VNĐ</span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <label class="fw-bold mb-2 text-dark">Tiền cọc (nếu có)</label>
                            <div class="input-group">
                                <input type="number" class="form-control py-2" name="deposit" placeholder="Nhập tiền cọc...">
                                <span class="input-group-text bg-light">VNĐ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-custom mb-4">
                <div class="card-body">
                    <h5 class="fw-bold text-primary mb-4 border-bottom pb-2">
                        <i class="bi bi-geo-alt me-2"></i>Vị trí bất động sản
                    </h5>
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <label class="fw-bold mb-2 text-dark">Quận / Huyện <span class="text-danger">*</span></label>
                            <select class="form-select py-2" name="district">
                                <option value="">-- Chọn Quận --</option>
                                <option value="q1">Quận 1</option>
                                <option value="q3">Quận 3</option>
                                <option value="q5">Quận 5</option>
                                <option value="q10">Quận 10</option>
                                <option value="qbt">Bình Thạnh</option>
                                <option value="gv">Gò Vấp</option>
                                <option value="td">TP. Thủ Đức</option>
                                </select>
                        </div>
                        <div class="col-md-8 mb-4">
                            <label class="fw-bold mb-2 text-dark">Địa chỉ chi tiết <span class="text-danger">*</span></label>
                            <input type="text" class="form-control py-2" name="address" placeholder="Số nhà, tên đường, phường/xã...">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-custom mb-4">
                <div class="card-body">
                    <h5 class="fw-bold text-primary mb-4 border-bottom pb-2">
                        <i class="bi bi-list-check me-2"></i>Thông tin chi tiết
                    </h5>
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <label class="fw-bold mb-2 text-dark">Số người ở tối đa</label>
                            <input type="number" class="form-control py-2" name="max_people" value="4">
                        </div>
                        <div class="col-md-4 mb-4">
                            <label class="fw-bold mb-2 text-dark">Đang ở hiện tại</label>
                            <input type="number" class="form-control py-2" name="current_people" value="0">
                        </div>
                        <div class="col-md-4 mb-4">
                            <label class="fw-bold mb-2 text-dark">SĐT Liên hệ</label>
                            <input type="text" class="form-control py-2" name="owner_phone" value="{{ user.profile.phone_number }}" placeholder="09xxxx...">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold mb-2 text-dark">Mô tả chi tiết</label>
                        <textarea class="form-control" name="description" rows="6" placeholder="Mô tả chi tiết về nội thất, tiện ích xung quanh, giờ giấc..."></textarea>
                    </div>
                </div>
            </div>

            <div class="card-custom mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                        <h5 class="fw-bold text-primary m-0">
                            <i class="bi bi-door-open me-2"></i>Danh sách phòng
                        </h5>
                        <button type="button" class="btn btn-sm btn-outline-primary rounded-pill fw-bold" onclick="addRoom()">
                            <i class="bi bi-plus-lg me-1"></i> Thêm phòng
                        </button>
                    </div>

                    <div class="alert alert-light border small text-muted mb-3">
                        <i class="bi bi-info-circle me-1"></i> Khai báo các phòng ngủ/phòng khách (nếu có) để khách dễ hình dung.
                    </div>

                    <div id="room-list-container">
                        <div class="room-item bg-light p-3 rounded mb-3 border position-relative">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-5">
                                    <label class="fw-bold small mb-1">Tên/Số phòng <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control form-control-sm" name="room_number[]" placeholder="VD: Phòng 101, Phòng ngủ Master...">
                                </div>
                                <div class="col-md-3">
                                    <label class="fw-bold small mb-1">Diện tích (m²)</label>
                                    <input type="number" class="form-control form-control-sm" name="room_area[]" placeholder="20">
                                </div>
                                <div class="col-md-4">
                                    <label class="fw-bold small mb-1">Nội thất (cách nhau dấu phẩy)</label>
                                    <input type="text" class="form-control form-control-sm" name="room_furniture[]" placeholder="Giường, Tủ, Máy lạnh...">
                                </div>
                            </div>
                            <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Close" onclick="removeRoom(this)" style="font-size: 10px;"></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-custom mb-4">
                <div class="card-body">
                    <h5 class="fw-bold text-primary mb-4 border-bottom pb-2">
                        <i class="bi bi-images me-2"></i>Hình ảnh & Video
                    </h5>
                    
                    <div class="mb-4">
                        <label class="fw-bold mb-2 text-dark">1. Ảnh đại diện (Ảnh bìa) <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" name="main_image" accept="image/*" onchange="previewMainImage(event)">
                        
                        <div class="mt-2" id="main-image-preview-box" style="display: none;">
                            <img id="main-img-preview" src="#" alt="Ảnh bìa" class="rounded shadow-sm border" style="max-height: 200px; width: auto;">
                        </div>
                    </div>

                    <hr>

                    <div class="mb-4">
                        <label class="fw-bold mb-2 text-dark">2. Ảnh chi tiết (Chọn nhiều ảnh)</label>
                        <input type="file" class="form-control" name="detail_images" accept="image/*" multiple onchange="previewGalleryImages(event)">
                        <div class="form-text">Giữ phím <strong>Ctrl</strong> (Windows) hoặc <strong>Command</strong> (Mac) để chọn nhiều ảnh.</div>
                    </div>

                    <div class="p-3 border border-dashed rounded bg-light" style="min-height: 200px; border-style: dashed !important; border-color: #ccc;">
                        
                        <div id="gallery-empty-state" class="d-flex flex-column align-items-center justify-content-center pt-5">
                            <i class="bi bi-cloud-arrow-up fs-1 text-muted mb-2"></i>
                            <span class="text-muted">Ảnh chi tiết sẽ hiển thị tại đây</span>
                        </div>

                        <div id="gallery-preview-container" class="row g-3">
                            </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end mb-5 gap-3">
                <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary px-4 py-2 fw-bold rounded-pill">
                    Hủy bỏ
                </a>
                <button type="submit" class="btn btn-danger px-5 py-2 fw-bold rounded-pill shadow-sm">
                    <i class="bi bi-send-fill me-2"></i> Đăng Tin Ngay
                </button>
            </div>

        </form>
    </div>
</div>

{% comment %} <script>
    // --- 1. Xử lý xem trước Ảnh đại diện (Main Image) ---
    function previewMainImage(event) {
        var reader = new FileReader();
        reader.onload = function(){
            var output = document.getElementById('main-img-preview');
            var box = document.getElementById('main-image-preview-box');
            output.src = reader.result;
            box.style.display = 'block';
        };
        if(event.target.files[0]) {
            reader.readAsDataURL(event.target.files[0]);
        }
    }

    // --- 2. Xử lý xem trước Nhiều ảnh (Gallery) ---
    function previewGalleryImages(event) {
        var container = document.getElementById('gallery-preview-container');
        var emptyState = document.getElementById('gallery-empty-state');
        var files = event.target.files;

        // Xóa ảnh cũ nếu chọn lại
        container.innerHTML = "";

        if (files.length > 0) {
            emptyState.style.display = 'none';

            for (var i = 0; i < files.length; i++) {
                var file = files[i];
                var reader = new FileReader();

                reader.onload = (function(f) {
                    return function(e) {
                        // Tạo khung col-3
                        var div = document.createElement('div');
                        div.className = 'col-6 col-md-3 position-relative';

                        // Tạo ảnh
                        var img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'img-fluid rounded shadow-sm border';
                        img.style.width = '100%';
                        img.style.height = '150px';
                        img.style.objectFit = 'cover';

                        div.appendChild(img);
                        container.appendChild(div);
                    };
                })(file);

                reader.readAsDataURL(file);
            }
        } else {
            emptyState.style.display = 'flex';
        }
    }

    // --- 3. Xử lý Thêm/Xóa Phòng (Dynamic Room) ---
    function addRoom() {
        var container = document.getElementById('room-list-container');
        
        // Tạo div dòng mới
        var newRoom = document.createElement('div');
        newRoom.className = 'room-item bg-light p-3 rounded mb-3 border position-relative';
        
        // HTML cho dòng mới
        newRoom.innerHTML = `
            <div class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label class="fw-bold small mb-1">Tên/Số phòng <span class="text-danger">*</span></label>
                    <input type="text" class="form-control form-control-sm" name="room_number[]" placeholder="VD: Phòng khách...">
                </div>
                <div class="col-md-3">
                    <label class="fw-bold small mb-1">Diện tích (m²)</label>
                    <input type="number" class="form-control form-control-sm" name="room_area[]">
                </div>
                <div class="col-md-4">
                    <label class="fw-bold small mb-1">Nội thất</label>
                    <input type="text" class="form-control form-control-sm" name="room_furniture[]" placeholder="Trống...">
                </div>
            </div>
            <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Close" onclick="removeRoom(this)" style="font-size: 10px;"></button>
        `;

        container.appendChild(newRoom);
    }

    function removeRoom(button) {
        var roomItem = button.closest('.room-item');
        // Kiểm tra nếu còn nhiều hơn 1 dòng thì mới cho xóa, hoặc xóa thoải mái tùy logic
        roomItem.remove();
    }
</script> {% endcomment %}
{% endblock %}